kernel:
  image: linuxkit/kernel:4.9.78
  cmdline: "console=tty0 console=ttyS0 rootfstype=tmpfs"
init:
  - iidlx/openrc:2971a534dae5449786e2735f971941dfe7a07a4b
  - linuxkit/runc:abc3f292653e64a2fd488e9675ace19a55ec7023
  - linuxkit/containerd:e58a382c33bb509ba3e0e8170dfaa5a100504c5b
  - iidlx/dockerd:e9bcfca8db2fb7615181295df7d02ad6386e1245
  - iidlx/kubernetes:ffd8d6643dfd4db2b7cf4f085bf14d59951f5be8-dirty
  - iidlx/etcd3:b0b95ed385a8fc63bb539f7f9031981c0c8d7ffa
  - linuxkit/ca-certificates:de21b84d9b055ad9dcecc57965b654a7a24ef8e0
  - linuxkit/firmware:8fc7d7702589b67e5b1aa72bb61cc72b47a048aa
files:
  - path: /init
    symlink: "/bin/busybox"
  - path: etc/runlevels/sysinit/sysfs
    symlink: "/etc/init.d/sysfs"
  - path: etc/runlevels/sysinit/devfs
    symlink: "/etc/init.d/devfs"
  - path: etc/runlevels/sysinit/procfs
    symlink: "/etc/init.d/procfs"
  - path: etc/runlevels/sysinit/mdev
    symlink: "/etc/init.d/mdev"
  - path: etc/runlevels/sysinit/hwclock
    symlink: "/etc/init.d/hwclock"
  - path: etc/runlevels/boot/hostname
    symlink: "/etc/init.d/hostname"
  - path: etc/runlevels/default/containerd
    symlink: "/etc/init.d/containerd"
  - path: etc/runlevels/boot/networking
    symlink: "/etc/init.d/networking"
  - path: etc/modules-load.d/packet.conf
    source: packet.conf
  - path: etc/network/interfaces
    contents: |
      auto eth0
      iface eth0 inet dhcp
  - path: etc/docker/daemon.json
    contents: '{"debug": true}'
  - path: etc/containerd/config.toml
    contents: |
      state = "/run/containerd"
      root = "/var/lib/containerd"
      snapshotter = "io.containerd.snapshotter.v1.overlayfs"
      differ = "io.containerd.differ.v1.base-diff"
      subreaper = false

      [grpc]
      address = "/run/containerd/containerd.sock"
      uid = 0
      gid = 0

      [debug]
      address = "/run/containerd/debug.sock"
      level = "info"

      [metrics]
      address = ":13337"
  - path: etc/init.d/kubelet
    mode: "777"
    contents: | 
      #!/sbin/openrc-run

      description="Kubelet"
      pidfile="/run/$RC_SVCNAME/$RC_SVCNAME.pid"
      name=$RC_SVCNAME
      #supervisor=start-stop-daemon

      command=/usr/bin/kubelet
      command_args="--allow-privileged=true --cgroup-root=/ --cluster-dns=100.64.0.10 --cluster-domain=cluster.local --enable-debugging-handlers=true --eviction-hard='memory.available<100Mi,nodefs.available<10%,nodefs.inodesFree<5%,imagefs.available<10%,imagefs.inodesFree<5%' --kubeconfig=/var/lib/kubelet/kubeconfig --network-plugin-mtu=9001 --network-plugin=kubenet --node-labels=kubernetes.io/role=master --non-masquerade-cidr=100.64.0.0/10 --pod-infra-container-image=gcr.io/google_containers/pause-amd64:3.0 --register-with-taints=node-role.kubernetes.io/master=:NoSchedule --v=2 --cni-bin-dir=/opt/cni/bin/ --cni-conf-dir=/etc/cni/net.d/"
      command_background="true"
      start_stop_daemon_args="--stdout /var/log/kubelet/${RC_SVCNAME}.log --stderr /var/log/kubelet/${RC_SVCNAME}.log"
     
      depend() {
        need dockerd
        provide kubelet
      }   


      start_pre()
      {
          # Ensure Service/Log DIR exits
          mkdir -p /run/$RC_SVCNAME/
          mkdir -p /var/log/$RC_SVCNAME/
      }
  - path: var/lib/kubelet/kubeconfig
    contents: |
      apiVersion: v1
      clusters:
      - cluster:
          certificate-authority: /etc/srv/kubernetes/pki/ca-certificates.crt 
          server: https://127.0.0.1
        name: local
      contexts:
      - context:
          cluster: local
          user: kubelet
        name: service-account-context
      current-context: service-account-context
      kind: Config
      users:
      - name: kubelet
        user:
          client-certificate: /etc/srv/kubernetes/pki/apiserver.crt 
          client-key: /etc/srv/kubernetes/pki/apiserver.key
  - path: etc/srv/kubernetes/pki/ca-certificates.crt
    source: tls/ca.crt
  - path: etc/srv/kubernetes/pki/apiserver.crt
    source: tls/apiserver.crt
  - path: etc/srv/kubernetes/pki/apiserver.key
    source: tls/apiserver.key
  - path: etc/runlevels/default/dockerd
    symlink: "/etc/init.d/dockerd"
  - path: etc/runlevels/default/kubelet
    symlink: "/etc/init.d/kubelet"
trust:
  org:
    - linuxkit
    - library
